<!DOCTYPE html>
<html>
  <head>
    <title>Sentry DevToolbar iFrame</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  </head>
  <body>
    <script>
      (function() {
        const referrer = __REFERRER__;
        const orgSlug = __ORG_SLUG__;
        const projectSlug = __PROJECT_SLUG__;

        function log(...args) {
          if (false) {
            console.log('iframe:', ...args);
          }
        }

        log('Init', {
          referrer,
          orgSlug,
          projectSlug,
        });

        // If we're logged out if the iframe, then nothing happens.
        // State will be [false,false,false] and user will need to click the button
        const message = projectSlug === undefined ? 'cookie-set' : 'project-ready';
        window.parent.postMessage({
          source: 'sentry-toolbar',
          message,
        }, referrer);
        log('Sent', {message, referrer})

        const {port1, port2} = new MessageChannel();

        const messageDispatch = {
          'log': log,
          'fetch': async (url, init) => {
            const response =  await fetch(url, {
              ...init,
              headers: {
                ...init.headers,
                // For mock/test purposes we're fetching the accessToken and injecting it
                'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
              }
            });

            return {
              ok: response.ok,
              status: response.status,
              statusText: response.statusText,
              url: response.url,
              headers: Object.fromEntries(response.headers.entries()),
              text: await response.text(),
            }
          },
        };

        port1.addEventListener('message', (postMessage) => {
          log('port.onMessage', postMessage.data);

          const {$id, message} = postMessage.data;
          if (!$id) {
            return; // MessageEvent is malformed, missing $id
          }

          if (!message.$function || !(message.$function in messageDispatch)) {
            return; // No-op without a $function to call
          }

          messageDispatch[message.$function]
            .apply(undefined, message.$args || [])
            .then($result => port1.postMessage({$id, $result}))
            .catch((error) => port1.postMessage({$id, $error: error}));
        });
        port1.start();

        window.parent.postMessage({
          source: 'sentry-toolbar',
          message: 'port-connect',
        }, referrer, [port2])
        log('Sent', {message: 'port-connect', referrer})
      })();
    </script>
  </body>
</html>
