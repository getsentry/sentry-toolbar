<!DOCTYPE html>
<html>
  <head>
    <title>Sentry DevToolbar iFrame</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  </head>
  <body>
    <script>
      const rnd = Math.random().toPrecision(2);
      const _logMessages = [];
      console.log('Log Messages', {rnd, _logMessages, window});
      document._logMessages = _logMessages;
      function logger(...args) {
        _logMessages.push(args);
        console.log('iframe:', rnd, ...args);
      }

      (function() {
        const referrer = __REFERRER__;
        const orgSlug = __ORG_SLUG__;
        const projectSlug = __PROJECT_SLUG__;

        logger('Init', {
          referrer,
          orgSlug,
          projectSlug,
        });

        // If we're logged out if the iframe, then nothing happens.
        // State will be [false,false,false] and user will need to click the button
        const message = projectSlug === undefined ? 'cookie-set' : 'project-ready';
        window.parent.postMessage({
          source: 'sentry-devtoolbar',
          message,
          rnd
        }, referrer);
        logger('Sent', {message, referrer})

        const {port1, port2} = new MessageChannel();

        const messageDispatch = {
          'log': logger,
          'fetch': (url, init) => fetch(url, {
            ...init,
            headers: {
              ...init.headers,
              // For mock/test purposes we're fetching the accessToken and injecting it
              'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
            }
          }),
        };

        port1.addEventListener('message', (postMessage) => {
          logger('port.onMessage', postMessage.data);

          const {$id, message} = postMessage.data;
          if (!$id) {
            return; // MessageEvent is malformed, missing $id
          }

          if (!message.$function || !(message.$function in handlerMap)) {
            return; // No-op without a $function to call
          }

          messageDispatch[message.$function]
            .apply(undefined, message.$args || [])
            .then($result => port1.postMessage({$id, $result}))
            .catch((error) => port1.postMessage({$id, $error: error}, [error]));
        });
        port1.start();

        window.parent.postMessage({
          source: 'sentry-devtoolbar',
          message: 'port-connect',
          rnd
        }, referrer, [port2])
        logger('Sent', {message: 'port-connect', referrer})

        logger('Is Ready')
      })();

    </script>
  </body>
</html>
